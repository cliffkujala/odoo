<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <record id="hr_timesheet_line_tree" model="ir.ui.view">
            <field name="name">hr.analytic.timesheet.tree</field>
            <field name="model">hr.analytic.timesheet</field>
            <field name="arch" type="xml">
                <tree editable="top" string="Timesheet Activities">                  
                    <field name="date" on_change="on_change_date(date)"/>
                    <field name="user_id" on_change="on_change_user_id(user_id)" required="1" options='{"no_open": True}'
                        context="{'default_groups_ref': ['base.group_user']}"/>
                    <field name="name"/>
                    <field domain="[('type','=','normal'),('use_timesheets','=',1)]" name="account_id" context="{'default_use_timesheets': 1, 'default_type': 'contract'}"/>
                    <field name="unit_amount" string="Duration" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" sum="Total time" widget="float_time"/>
                    <field name="product_uom_id" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" invisible="1"/>
                    <field name="journal_id" invisible="1"/>
                    <field name="amount" sum="Total cost" invisible="1"/>
                    <field name="general_account_id" invisible="1"/>
                    <field name="product_id" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" required="1" domain="[('type','=','service')]" invisible="1"/>
                </tree>
            </field>
        </record>
        <record id="hr_timesheet_line_form" model="ir.ui.view">
            <field name="name">hr.analytic.timesheet.form</field>
            <field name="model">hr.analytic.timesheet</field>
            <field name="arch" type="xml">
                <form string="Timesheet Activities" version="7.0">
                    <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="user_id" on_change="on_change_user_id(user_id)" required="1"
                                context="{'default_groups_ref': ['base.group_user']}"/>
                        </group>
                        <group>
                            <field name="date" on_change="on_change_date(date)"/>
                            <field name="sheet_id" />
                        </group>
                    </group>
                    <notebook>
                        <page string="Information">
                        <group>
                            <group string="Product">
                                <field name="product_id" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" required="1" domain="[('type','=','service')]"/>
                                <label string="Duration" for="unit_amount"/>
                                <div>
                                    <field name="unit_amount" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" class="oe_inline"/>
                                    <field name="product_uom_id" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" class="oe_inline"/>
                                </div>
                            </group>
                            <group string="Accounting">
                                <field domain="[('type','=','normal'),('state', '&lt;&gt;', 'close'),('parent_id','!=',False)]" name="account_id" select="1"/>
                                <field name="amount"/>
                                <field name="general_account_id"/>
                                <field name="journal_id"/>
                            </group>
                        </group>
                        </page>
                    </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="hr_timesheet_line_search" model="ir.ui.view">
            <field name="name">hr.analytic.timesheet.search</field>
            <field name="model">hr.analytic.timesheet</field>
            <field name="arch" type="xml">
                <search string="Timesheet">
                    <field name="date"/>
                    <field name="sheet_id"/>
                    <field name="user_id"/>
                    <field name="account_id"/>
                    <group expand="0" string="Group By...">
                        <filter string="Users" icon="terp-personal" domain="[]" context="{'group_by':'user_id'}"/>
                        <filter string="Analytic account" icon="terp-folder-green" domain="[]" context="{'group_by':'account_id'}"/>
                        <filter string="Product" icon="terp-accessories-archiver" domain="[]" context="{'group_by':'product_id'}"/>
                        <filter string="Timesheet Month" icon="terp-go-month" domain="[]" context="{'group_by':'date'}" help="Timesheet by Month"/>
                    </group>
                </search>
            </field>
        </record>

        <record model="ir.actions.act_window" id="act_analytic_cost_revenue">
            <field name="context">{'search_default_group_date': 1, 'search_default_group_journal': 1}</field>
            <field name="domain">[('account_id','child_of', active_id)]</field>
            <field name="name">Costs &amp; Revenues</field>
            <field name="res_model">account.analytic.line</field>
            <field name="src_model">account.analytic.account</field>
            <field name="view_mode">tree,form</field>
            <field name="view_type">form</field>
            <field name="help" type="html">
              <p>
                No activity yet on this contract.
              </p><p>
                In OpenERP, contracts and projects are implemented using
                analytic account. So, you can track costs and revenues to analyse
                your margins easily.
              </p><p>
                Costs will be created automatically when you register supplier
                invoices, expenses or timesheets.
              </p><p>
                Revenues will be created automatically when you create customer
                invoices. Customer invoices can be created based on sale orders
                (fixed price invoices), on timesheets (based on the work done) or
                on expenses (e.g. reinvoicing of travel costs).
              </p>
            </field>
        </record>

 
        <record id="account_analytic_account_timesheet_form" model="ir.ui.view">
            <field name="name">account.analytic.account.invoice.form</field>
            <field name="model">account.analytic.account</field>
            <field name="inherit_id" ref="analytic.view_account_analytic_account_form"/>
            <field name="arch" type="xml">
                <xpath expr='//div[@name="project"]' position='inside'>
                    <field name="use_timesheets"/>
                    <label for="use_timesheets"/>
                </xpath>
                <xpath expr='//div[@name="buttons"]' position='inside'>
                    <button class="oe_inline oe_stat_button" type="action" name="%(act_analytic_cost_revenue)d" 
                        icon="fa-usd"  string="Cost/Revenue" widget="statinfo"/>
                </xpath>
            </field>
        </record>
        
        <record id="act_hr_timesheet_accounts_form" model="ir.actions.act_window">
            <field name="name">Timesheet Accounts</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">account.analytic.account</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('use_timesheets','=', True)]</field>
            <field name="context">{'default_use_timesheets':1}</field>
        </record>

        <menuitem parent="hr.menu_hr_configuration" id="menu_timesheet_accounts" action="act_hr_timesheet_accounts_form" sequence="7" groups="base.group_hr_manager"/>
        
        <record id="act_hr_timesheet_line_evry1_all_form" model="ir.actions.act_window">
            <field name="name">Timesheet Activities</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">hr.analytic.timesheet</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{"search_default_today":1}</field>
            <field name="search_view_id" ref="hr_timesheet_line_search"/>
            <field name="help" type="html">
              <p class="oe_view_nocontent_create">
                Click to record activities.
              </p><p>
                You can register and track your workings hours by project every
                day. Every time spent on a project will become a cost in the
                analytic accounting/contract and can be re-invoiced to
                customers if required.
              </p>
            </field>
        </record>

        <!-- Timesheet Button on Employee Form -->
           
        <record id="act_hr_employee_2_hr_timesheet" model="ir.actions.act_window">
            <field name="res_model">hr_timesheet_sheet.sheet</field>
            <field name="view_type">form</field>
            <field name="name">Timesheets</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{'search_default_employee_id': [active_id], 'default_employee_id': active_id}</field>
        </record>

        <record id="hr_timesheet_employee_extd_form" model="ir.ui.view">
            <field name="name">hr.timesheet.employee.extd_form</field>
            <field name="model">hr.employee</field>
            <field name="inherit_id" ref="hr.view_employee_form"/>
            <field name="arch" type="xml">
                <xpath expr="//group[@name='active_group']" position="before">
                    <group string="Timesheets">
                        <field name="product_id" domain="[('type','=','service')]"/>
                        <field name="journal_id"/>
                    </group>
                </xpath>
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="%(act_hr_employee_2_hr_timesheet)d" 
                        type="action"
                        class="oe_stat_button"
                        icon="fa-clock-o" 
                        groups="base.group_hr_manager">
                        <field name="timesheet_count" widget="statinfo" string="Timesheets"/>
                    </button>
                </xpath>
            </field>
        </record>

        <menuitem id="menu_hr_timesheet_reports" parent="hr.menu_hr_reporting" sequence="5" name="Timesheet"/>


        <record model="ir.actions.act_window" id="act_hr_timesheet_sheet_2_hr_analytic_timesheet">
            <field name="context">{'search_default_sheet_id': [active_id]}</field>
            <field name="name">Timesheet Activities</field>
            <field name="res_model">hr.analytic.timesheet</field>
            <field name="src_model">hr_timesheet_sheet.sheet</field>
        </record>

        <record id="hr_timesheet_form" model="ir.ui.view">
            <field name="name">hr.timesheet.form</field>
            <field name="model">hr_timesheet_sheet.sheet</field>
            <field name="arch" type="xml">
                <form string="Timesheet" version="7.0">
                <header>
                    <button name="button_confirm" states="draft" string="Freeze Timesheet" type="object" groups="base.group_hr_manager" class="oe_highlight"/>
                    <field name="state" widget="statusbar" statusbar_visible="new,confirm,done"/>
                </header>
                <sheet>
                    <div class="oe_right oe_button_box" name="buttons">
                        <button type="action"
                            name="%(act_hr_timesheet_sheet_2_hr_analytic_timesheet)d"
                            class="oe_stat_button"
                            icon="fa-clock-o">
                            <field name="timesheet_activity_count" widget="statinfo" string="Timesheet" help="Timesheet Activities"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <label for="employee_id" class="oe_edit_only"/>
                        <h1><field name="employee_id" on_change="onchange_employee_id(employee_id)" class="oe_inline"/></h1>
                        <field name="user_id" invisible="1"/>
                    </div>
                    <group>
                        <group>
                            <label for="date_from" string="Timesheet Period"/>
                            <div><field name="date_from" class="oe_inline"/> to <field name="date_to" class="oe_inline"/></div>
                            <field name="name" invisible="1"/>
                            <field name="department_id" invisible="1"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Weekly Timesheet">
                            <widget type="weekly_timesheet" attrs="{'readonly': [['state', 'not in', ['new', 'draft']]]}">
                            </widget>
                        </page>
                        <page string="Daily Timesheet">
                            <widget type="daily_timesheet" attrs="{'readonly': [['state', 'not in', ['new', 'draft']]]}">
                            </widget>
                        </page>
                        <page string="Details">
                            <field context="{'employee_id': employee_id, 'user_id':user_id, 'timesheet_date_from': date_from, 'timesheet_date_to': date_to}" name="timesheet_ids" nolabel="1">
                                <tree editable="top" string="Timesheet Activities">
                                    <field name="date"/>
                                    <field domain="[('type','in',['normal', 'contract']), ('state', '&lt;&gt;', 'close'),('use_timesheets','=',1)]" name="account_id" on_change="on_change_account_id(account_id, user_id)" context="{'default_use_timesheets': 1}"/>
                                    <field name="name"/>
                                    <field name="unit_amount" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" widget="float_time" string="Hours" sum="Hours"/>
                                    <!-- <field name="to_invoice" widget="selection"/> -->
                                    <field invisible="1" name="journal_id"/>
                                    <field invisible="1" name="product_id" domain="[('type','=','service')]" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)"/>
                                    <field invisible="1" name="product_uom_id" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)"/>
                                    <field invisible="1" name="amount"/>
                                    <field invisible="1" name="general_account_id"/>
                                    <field invisible="1" name="user_id" required="1"/>
                                </tree>
                                <form string="Timesheet Activities" version="7.0">
                                    <field name="date"/>
                                    <field domain="[('type','=','normal'), ('state', '&lt;&gt;', 'close')]" name="account_id" on_change="on_change_account_id(account_id, user_id)"/>
                                    <field name="name"/>
                                    <field name="unit_amount" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)" widget="float_time"/>
                                    <!-- <field name="to_invoice"/> -->
                                    <field name="journal_id"/>
                                    <field name="product_id" domain="[('type','=','service')]" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)"/>
                                    <field name="product_uom_id" on_change="on_change_unit_amount(product_id, unit_amount, False, product_uom_id,journal_id)"/>
                                    <field name="amount"/>
                                    <field name="general_account_id"/>
                                    <field name="user_id" required="1"/>
                                </form>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids" widget="mail_thread"/>
                    <field name="message_follower_ids" widget="mail_followers"/>
                </div>
                </form>
            </field>
        </record>

        <record id="view_hr_timesheet_filter" model="ir.ui.view">
            <field name="name">hr_timesheet.filter</field>
            <field name="model">hr_timesheet_sheet.sheet</field>
            <field name="arch" type="xml">
                <search string="Search Timesheet">
                    <field name="date_from"/>
                    <filter name="new" string="In Draft" domain="[('state','in',('draft', 'new'))]" help="Unvalidated Timesheets"/>
                    <filter name="to_approve" string="To Approve" domain="[('state','=','confirm')]" help="Confirmed Timesheets"/>
                    <field name="employee_id"/>
                    <field name="department_id"/>
                    <group expand="0" string="Group By...">
                        <filter string="Employees" icon="terp-personal" domain="[]" context="{'group_by':'employee_id'}"/>
                        <filter string="Department" icon="terp-personal+" domain="[]" context="{'group_by':'department_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="act_hr_timesheet_form" model="ir.actions.act_window">
            <field name="name">Timesheets to Validate</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">hr_timesheet_sheet.sheet</field>
            <field name="view_type">form</field>
            <field name="view_id" eval="False"/>
            <field name="context">{'search_default_to_approve':1}</field>
            <field name="search_view_id" ref="view_hr_timesheet_filter"/>
            <field name="help" type="html">
              <p class="oe_view_nocontent_create">
                New timesheet to approve.
              </p><p>
                You must record timesheets every day and confirm at the end
                of the week. Once the timesheet is confirmed, it should be
                validated by a manager.
              </p><p>
                Timesheets can also be invoiced to customers, depending on the
                configuration of each project's related contract.
              </p>
            </field>
        </record>

        <menuitem id="menu_hr_time_tracking" name="Time Tracking" parent="hr.menu_hr_root" sequence="5" groups="base.group_user,base.group_hr_user,base.group_hr_manager"/>

        <menuitem id="menu_hr_working_hours" parent="menu_hr_time_tracking" action="act_hr_timesheet_line_evry1_all_form"/>

        <menuitem action="act_hr_timesheet_form" id="menu_act_hr_timesheet_form" parent="menu_hr_time_tracking"
             sequence="2" groups="base.group_hr_user"/>

        <!--
            Company inheritancy
        -->
        <record id="hr_timesheet_company" model="ir.ui.view">
            <field name="name">res.company.timesheet</field>
            <field name="model">res.company</field>
            <field name="inherit_id" ref="base.view_company_form"/>
            <field name="arch" type="xml">
                <xpath expr="//group[@name='account_grp']" position="after">
                    <group name="timesheets_grp" string="Timesheets">
                        <field name="timesheet_range"/>
                    </group>
                </xpath>
            </field>
        </record>

        <!--
            hr.analytic.timesheet inheritancy

        <record id="hr_timesheet_line_form" model="ir.ui.view">
            <field name="name">hr.analytic.timesheet.form</field>
            <field name="model">hr.analytic.timesheet</field>
            <field name="inherit_id" ref="hr_timesheet.hr_timesheet_line_form"/>
            <field name="arch" type="xml">
                <field name="date" position="after">
                    <field name="sheet_id" />
                </field>
            </field>
        </record>

        <record id="hr_timesheet_line_search" model="ir.ui.view">
            <field name="name">hr.analytic.timesheet.search</field>
            <field name="model">hr.analytic.timesheet</field>
            <field name="inherit_id" ref="hr_timesheet.hr_timesheet_line_search"/>
            <field name="arch" type="xml">
                <field name="date" position="before">
                    <field name="sheet_id"/>
                </field>
            </field>
        </record>
        -->

        <record id="hr_timesheet_tree_simplified" model="ir.ui.view">
            <field name="name">hr.timesheet.tree</field>
            <field name="model">hr_timesheet_sheet.sheet</field>
            <field eval="10" name="priority"/>
            <field name="arch" type="xml">
                <tree colors="blue:state == 'draft';black:state in ('confirm','new');gray:state == 'done'" string="Timesheets">
                    <field name="employee_id"/>
                    <field name="date_from"/>
                    <field name="date_to"/>
                    <field name="department_id" invisible="1"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

    </data>
</openerp>
